<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@14.1.2/marked.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .markdown h1 { @apply text-2xl font-bold mt-6 mb-3; }
        .markdown h2 { @apply text-xl font-bold mt-5 mb-2; }
        .markdown h3 { @apply text-lg font-bold mt-4 mb-2; }
        .markdown p { @apply mb-3 leading-relaxed; }
        .markdown code { @apply bg-gray-100 dark:bg-gray-800 px-1 py-0.5 rounded text-sm font-mono; }
        .markdown pre { @apply bg-gray-900 dark:bg-gray-800 p-4 rounded-lg overflow-x-auto mt-4 mb-4; }
        .markdown pre code { @apply bg-transparent p-0 rounded-none text-inherit font-mono; }
        .markdown ul, .markdown ol { @apply mb-4 ml-6; }
        .markdown li { @apply mb-1; }
        .markdown blockquote { @apply border-l-4 border-blue-500 pl-4 italic text-gray-600 dark:text-gray-400 my-4; }
        .markdown a { @apply text-blue-600 hover:underline; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-white dark:from-slate-900 dark:to-slate-800 min-h-screen flex flex-col text-slate-900 dark:text-slate-100 transition-colors duration-300">
    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-white dark:bg-slate-900 flex items-center justify-center z-50">
        <div class="text-xl">Loading AI Chat...</div>
    </div>

    <!-- Header -->
    <header class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-md sticky top-0 z-40 border-b border-slate-200 dark:border-slate-700 px-6 py-4 flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">AI Chat</h1>
        </div>
        <div class="flex items-center space-x-3">
            <button id="new-chat" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all duration-200 text-sm font-medium">New Chat</button>
            <button id="settings-btn" class="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors">‚öôÔ∏è</button>
            <button id="dark-mode-toggle" class="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors">üåô</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-80 bg-white/50 dark:bg-slate-800/50 backdrop-blur-md border-r border-slate-200 dark:border-slate-700 flex flex-col fixed h-[calc(100vh-80px)] z-30 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="p-6 border-b border-slate-200 dark:border-slate-700">
                <h2 class="font-semibold text-lg mb-4">Chats</h2>
                <div class="space-y-2">
                    <div id="chat-list"></div>
                </div>
            </div>
        </aside>

        <!-- Overlay for mobile sidebar -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-20 lg:hidden hidden"></div>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col overflow-hidden lg:ml-0">
            <!-- Chat Header -->
            <div id="chat-header" class="p-6 border-b border-slate-200 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm sticky top-20 z-10 hidden">
                <div class="flex items-center justify-between">
                    <div>
                        <input id="chat-title" class="font-semibold text-xl bg-transparent border-none focus:outline-none w-full px-2 py-1" placeholder="Chat Title">
                    </div>
                    <button id="chat-menu" class="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg">‚ãÆ‚ãÆ</button>
                </div>
            </div>

            <!-- Messages Container -->
            <div id="messages" class="flex-1 overflow-y-auto p-6 space-y-6 scrollbar-thin scrollbar-thumb-slate-300 dark:scrollbar-thumb-slate-600">
                <div class="text-center text-slate-500 dark:text-slate-400 text-sm">Start a conversation by typing below...</div>
            </div>

            <!-- Input Bar -->
            <div class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-md border-t border-slate-200 dark:border-slate-700 p-6 sticky bottom-0 z-30">
                <div class="max-w-4xl mx-auto flex items-end space-x-3">
                    <div class="flex-1 relative">
                        <textarea 
                            id="message-input"
                            rows="1"
                            placeholder="Type your message..."
                            class="w-full resize-none bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-2xl px-5 py-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base placeholder-slate-500 dark:placeholder-slate-400 transition-all duration-200"
                            maxlength="4000"
                        ></textarea>
                        <div id="char-count" class="absolute bottom-2 right-3 text-xs text-slate-400 hidden"></div>
                    </div>
                    <button 
                        id="send-btn"
                        class="w-12 h-12 bg-blue-500 hover:bg-blue-600 text-white rounded-2xl flex items-center justify-center transition-all duration-200 shadow-lg hover:shadow-xl flex-shrink-0"
                        disabled
                    >
                        ‚û§
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">Settings</h2>
                <button id="close-settings" class="text-2xl">√ó</button>
            </div>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-2">OpenRouter API Key</label>
                    <input id="api-key" type="password" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-900" placeholder="sk-or-...">
                    <p class="text-xs text-slate-500 mt-1">Get your key at openrouter.ai</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Model</label>
                    <select id="model-select" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-900">
                        <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                        <option value="anthropic/claude-3-haiku">Claude 3 Haiku</option>
                        <option value="openai/gpt-4o">GPT-4o</option>
                        <option value="google/gemini-pro">Gemini Pro</option>
                        <option value="meta-llama/llama-3.1-405b-instruct:free">Llama 3.1 405B (Free)</option>
                    </select>
                </div>
                <div class="flex space-x-3 pt-2">
                    <button id="save-settings" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl transition-all duration-200 font-medium">Save & Test</button>
                    <button id="cancel-settings" class="flex-1 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-900 dark:text-slate-100 px-6 py-3 rounded-xl transition-all duration-200">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Menu -->
    <div id="chat-menu-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-xl p-4 w-48">
            <button id="rename-chat" class="w-full text-left px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">Rename</button>
            <button id="delete-chat" class="w-full text-left px-4 py-2 hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400 rounded-lg transition-colors mt-1">Delete Chat</button>
        </div>
    </div>

    <!-- System Prompt Modal -->
    <div id="system-prompt-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">System Prompt</h2>
                <button id="close-system-prompt" class="text-2xl">√ó</button>
            </div>
            <textarea id="system-prompt-text" rows="8" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-900 resize-vertical" placeholder="Define the AI's personality and behavior..."></textarea>
            <div class="flex space-x-3 pt-4">
                <button id="save-system-prompt" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl transition-all duration-200 font-medium">Save</button>
                <button id="cancel-system-prompt" class="flex-1 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-900 dark:text-slate-100 px-6 py-3 rounded-xl transition-all duration-200">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        (function() {
            'use strict';

            // App State
            const app = {
                currentChatId: null,
                chats: [],
                isDarkMode: false,
                isStreaming: false,
                abortController: null,
                initialized: false
            };

            // DOM Elements
            const elements = {};
            const queries = {
                loading: '#loading',
                sidebar: '#sidebar',
                sidebarOverlay: '#sidebar-overlay',
                messages: '#messages',
                messageInput: '#message-input',
                sendBtn: '#send-btn',
                newChat: '#new-chat',
                settingsBtn: '#settings-btn',
                darkModeToggle: '#dark-mode-toggle',
                settingsModal: '#settings-modal',
                closeSettings: '#close-settings',
                apiKey: '#api-key',
                modelSelect: '#model-select',
                saveSettings: '#save-settings',
                cancelSettings: '#cancel-settings',
                chatList: '#chat-list',
                chatHeader: '#chat-header',
                chatTitle: '#chat-title',
                chatMenu: '#chat-menu',
                chatMenuModal: '#chat-menu-modal',
                renameChat: '#rename-chat',
                deleteChat: '#delete-chat',
                systemPromptModal: '#system-prompt-modal',
                systemPromptText: '#system-prompt-text',
                closeSystemPrompt: '#close-system-prompt',
                saveSystemPrompt: '#save-system-prompt',
                cancelSystemPrompt: '#cancel-system-prompt',
                charCount: '#char-count'
            };

            // Storage Utils
            const storage = {
                get(key) {
                    try {
                        const item = localStorage.getItem(key);
                        return item ? JSON.parse(item) : null;
                    } catch {
                        return null;
                    }
                },
                set(key, value) {
                    try {
                        localStorage.setItem(key, JSON.stringify(value));
                    } catch (e) {
                        console.warn('Storage failed:', e);
                    }
                },
                remove(key) {
                    try {
                        localStorage.removeItem(key);
                    } catch {}
                }
            };

            // UUID Generator
            function uuid() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                    const r = Math.random() * 16 | 0;
                    return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
                });
            }

            // Initialize App
            function init() {
                Object.entries(queries).forEach(([key, selector]) => {
                    elements[key] = document.querySelector(selector);
                });

                loadState();
                bindEvents();
                renderChats();
                hideLoading();

                if (app.chats.length === 0) {
                    createNewChat();
                } else {
                    switchToChat(app.currentChatId || app.chats[0]?.id);
                }

                app.initialized = true;
            }

            function hideLoading() {
                elements.loading.style.display = 'none';
            }

            // State Management
            function loadState() {
                app.chats = storage.get('chats') || [];
                app.isDarkMode = storage.get('darkMode') || false;
                app.currentChatId = storage.get('currentChatId') || null;
                
                const savedKey = storage.get('apiKey');
                if (savedKey) {
                    elements.apiKey.value = atob(savedKey);
                }
                
                const savedModel = storage.get('model') || 'anthropic/claude-3.5-sonnet';
                elements.modelSelect.value = savedModel;
                
                updateTheme();
            }

            function saveState() {
                storage.set('chats', app.chats);
                storage.set('currentChatId', app.currentChatId);
                storage.set('darkMode', app.isDarkMode);
                storage.set('model', elements.modelSelect.value);
                storage.set('apiKey', btoa(elements.apiKey.value));
            }

            // Theme Management
            function updateTheme() {
                document.body.classList.toggle('dark', app.isDarkMode);
                elements.darkModeToggle.textContent = app.isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            }

            function toggleDarkMode() {
                app.isDarkMode = !app.isDarkMode;
                updateTheme();
                saveState();
            }

            // Chat Management
            function createNewChat() {
                const newChat = {
                    id: uuid(),
                    title: 'New Chat',
                    messages: [],
                    created: Date.now(),
                    systemPrompt: storage.get('globalSystemPrompt') || ''
                };
                
                app.chats.unshift(newChat);
                app.currentChatId = newChat.id;
                saveState();
                renderChats();
                switchToChat(newChat.id);
            }

            function switchToChat(chatId) {
                const chat = app.chats.find(c => c.id === chatId);
                if (!chat) return;

                app.currentChatId = chatId;
                elements.chatTitle.value = chat.title;
                renderMessages(chat.messages);
                saveState();
                elements.chatHeader.classList.remove('hidden');
            }

            function renderChats() {
                const html = app.chats.map(chat => `
                    <button class="chat-item w-full text-left p-3 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 transition-all duration-200 flex items-center justify-between group ${app.currentChatId === chat.id ? 'bg-blue-100 dark:bg-blue-900/30 border-2 border-blue-200 dark:border-blue-800' : ''}" data-chat-id="${chat.id}">
                        <div class="truncate flex-1">
                            <div class="font-medium truncate">${chat.title}</div>
                            <div class="text-xs text-slate-500 truncate">${chat.messages.length} messages</div>
                        </div>
                        <div class="opacity-0 group-hover:opacity-100 transition-opacity flex items-center space-x-1">
                            <div class="w-1 h-1 bg-slate-400 rounded-full"></div>
                        </div>
                    </button>
                `).join('');
                
                elements.chatList.innerHTML = html;
            }

            function renderMessages(messages) {
                const container = elements.messages;
                container.innerHTML = messages.map(msg => createMessageHTML(msg)).join('');
                
                // Auto-scroll to bottom
                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            }

            function createMessageHTML(msg) {
                const isUser = msg.role === 'user';
                const className = isUser 
                    ? 'bg-blue-500 text-white ml-auto' 
                    : 'bg-white dark:bg-slate-800 shadow-lg border border-slate-200 dark:border-slate-700';
                
                const markdownContent = marked.parse(msg.content || '', { 
                    breaks: true,
                    gfm: true 
                });

                return `
                    <div class="message ${isUser ? 'flex justify-end' : 'flex justify-start'}">
                        <div class="max-w-3xl ${className} rounded-2xl p-5 ${isUser ? 'rounded-br-sm' : 'rounded-bl-sm'} ${isUser ? '' : 'max-w-[85%]' }">
                            ${isUser ? '' : '<div class="w-6 h-6 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full mb-2 flex-shrink-0"></div>'}
                            <div class="markdown prose prose-sm dark:prose-invert max-w-none leading-relaxed">${markdownContent}</div>
                            <div class="text-xs mt-2 opacity-75">${new Date(msg.timestamp).toLocaleTimeString()}</div>
                        </div>
                    </div>
                `;
            }

            // API Integration
            async function sendMessage(content) {
                if (!content.trim() || app.isStreaming || !elements.apiKey.value.trim()) return;

                const chat = app.chats.find(c => c.id === app.currentChatId);
                if (!chat) return;

                // Add user message
                chat.messages.push({
                    role: 'user',
                    content: content.trim(),
                    timestamp: Date.now()
                });

                renderMessages(chat.messages);
                elements.messageInput.value = '';
                updateSendButton();
                saveState();

                // Prepare AI response
                const aiMessage = {
                    role: 'assistant',
                    content: '',
                    timestamp: Date.now()
                };
                chat.messages.push(aiMessage);
                renderMessages(chat.messages);

                try {
                    app.isStreaming = true;
                    updateSendButton();

                    const response = await fetch('https://openrouter.ai/api/v1/chat/compl
